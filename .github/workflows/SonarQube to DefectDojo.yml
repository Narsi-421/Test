name: SonarQube to DefectDojo Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  SONAR_PROJECT_KEY: juice-shop
  SONAR_PROJECT_NAME: JuiceShop
  DEFECTDOJO_ENGAGEMENT_ID: 4

jobs:
  sonarqube-analysis:
    runs-on: self-hosted

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Add SonarScanner to PATH
      run: echo "/opt/sonar-scanner/bin" >> $GITHUB_PATH

    - name: SonarQube Analysis
      run: |
        sonar-scanner \
          -Dsonar.projectKey=${{ env.SONAR_PROJECT_KEY }} \
          -Dsonar.projectName=${{ env.SONAR_PROJECT_NAME }} \
          -Dsonar.sources=. \
          -Dsonar.host.url=${{ secrets.SONAR_URL }} \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}

    - name: Download SonarQube Report
      run: |
        curl -u ${{ secrets.SONAR_TOKEN }}: \
          "${{ secrets.SONAR_URL }}/api/issues/search?componentKeys=${{ env.SONAR_PROJECT_KEY }}&resolved=false&ps=500" \
          -o sonarqube-report.json
        echo "SonarQube report downloaded with size: $(wc -c < sonarqube-report.json) bytes"

    - name: Validate JSON file
      run: |
        jq empty sonarqube-report.json
        echo "JSON validation passed"

    - name: Upload SonarQube Report to DefectDojo
      run: |
        echo "Attempting to upload to DefectDojo..."
        response=$(curl -s -w "\n%{http_code}" -X POST \
          "${{ secrets.DEFECTDOJO_URL }}/api/v2/import-scan/" \
          -H "Authorization: Token ${{ secrets.DEFECTDOJO_API_TOKEN }}" \
          -F "scan_type=SonarQube Scan" \
          -F "engagement=${{ env.DEFECTDOJO_ENGAGEMENT_ID }}" \
          -F "file=@sonarqube-report.json" \
          -F "active=true" \
          -F "verified=true")
        
        http_code=$(echo "$response" | tail -n1)
        body=$(echo "$response" | sed '$d')
        
        echo "HTTP Status Code: $http_code"
        echo "Response Body: $body"
        
        if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
          echo "Upload successful"
          exit 0
        else
          echo "Upload failed"
          exit 1
        fi

    - name: Archive Report
      uses: actions/upload-artifact@v4
      with:
        name: sonarqube-results
        path: sonarqube-report.json
